<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache,must-revalidate">
    <meta http-equiv="expires" content="0">
    <meta http-equiv="Access-Control-Allow-Origin" content="http://122.64.173.79:9080"/>
    <title></title>
    <link rel="stylesheet" href="css/layui.css"/>
    <link rel="stylesheet" href="css/bootstrap.css"/>
    <link rel="stylesheet" href="css/bootstrap-switch.css"/>
    <link rel="stylesheet" href="css/jeDate-test.css"/>
    <link rel="stylesheet" href="css/jedate.css"/>
    <link rel="stylesheet" href="css/policy.css"/>
</head>
<body>
<div class="main">
    <div class="policyInfo">
        <div class="policy-header">
            <span class="policy-header-text">安全策略列表</span>
        </div>
        <div class="policy-operation clearfix">
            <ul class="policy-ope-nav fl clearfix">
                <li class="fl">
                    <span title="新建" class="policy-add policy-nav-text policy-add-img" data-toggle="modal" data-target="#policyForm">新建</span>
                </li>
                <li class="fl">
                    <span title="删除" class="policy-delete policy-nav-text policy-delete-img">删除</span>
                </li>
                <li class="fl">
                    <span title="移动" class="policy-move policy-nav-text policy-move-img">移动</span>
                </li>
                <li class="fl">
                    <span title="导出" class="policy-export policy-nav-text policy-export-img">导出</span>
                </li>
                <li class="fl">
                    <span title="刷新" class="policy-refresh policy-nav-text policy-refresh-img">刷新</span>
                </li>
            </ul>
            <div class="policy-search fr">
                <input id="searchInput" class="policy-search-text" type="text" placeholder="请输入搜索内容..."/>
                <span class="policy-search-btn policy-search-btn-img">查询</span>
            </div>
        </div>
        <div class="policy-table clearfix">
            <table id="policy-table" class="table table-bordered table-hover">
                <tr id="thead">
                    <th><input id="allChange" type="checkbox"/></th>
                    <th>ID</th>
                    <th>源地址</th>
                    <th>目的地址</th>
                    <th>协议</th>
                    <th>端口</th>
                    <th>时间段</th>
                    <th>长连接</th>
                    <th>动作</th>
                    <th>描述</th>
                </tr>
            </table>
            <div id="pagediv" style="float:right;margin-right:8px;line-height: 27px;">
                <span id="btn0"></span>
                <!--<input id="pageSize" type="text" size="1" maxlength="2" value="10"/>-->
                <select id="pageSize">
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select>
                <span> 条 </span>
                <span id="allNum"></span>
                <a  href="###" id="btn1">首页</a>
                <a  href="###" id="btn2">上一页</a>
                <a  href="###" id="btn3">下一页</a>
                <a  href="###" id="btn4">尾页</a>
                <span>转到 </span>
                <input id="changePage" type="text" size="1" maxlength="4"/>
                <span>页 </span>
                <a  href="###" id="btn5">跳转</a>
            </div>
        </div>
    </div>
</div>


<!--<iframe id="getVPC" name="getVPC" src="http://122.64.173.79:9080/icbc/iaase/api/firewall/getVPCRules?tenantName=saas1&tenantID=1201-I-APP-112787" hidden frameborder="0"></iframe>-->

<script src="./js/jquery-1.10.2.js"></script>
<script src="js/jquery.jsonp.js"></script>
<script src="./js/bootstrap.min.js"></script>
<script src="js/bootstrap-switch.js"></script>
<script src="js/jedate.js"></script>

<script type="text/javascript">
    /*$.jsonp({
        url:'http://122.64.173.79:9080/icbc/iaase/api/firewall/getVPCRules?tenantName=saas1&tenantID=1201-I-APP-112787',
       // data:{tenantName:'saas1',tenantID:'1201-I-APP-112787'},
        //callback:'getVPCRules',
        success:function(json){
            console.log(json);
        },
        error:function(xOptions,textStatus){
            alert("服务器异常！！！");
        }
    });*/

    /*window.getData=function (obj){
        var ss=eval(obj);
        alert("请求成功");
    };*/

    /*  var url="http://122.64.173.79:9080/icbc/iaase/api/firewall/getVPCRules?callback=getData";
    var script=document.createElement("script");
    script.src=url;
    document.body.appendChild(script);*/

    /*window.onload=function(){
        var src=window.top.document.getElementById("getVPC");
        var bb=$(src).find("body");
        console.log(bb);
       //. $("iframe").contents().find('body').html();

       /!* var bb=document.getElementById("getVPC").textContent;
        console.log(bb);*!/
    };*/
    /*document.domain="http://122.64.173.80";*/
    /*var iframe=$("#getVPC");
    var getVPC=$(iframe).contentWindow;
    iframe.onload=function(){
        var data={tenantName: "saas1",tenantID: "1201-I-APP-112787"};
        getVPC.postMessage(JSON.stringify(data),'http://122.64.173.79:9080/icbc/iaase/api/firewall/getVPCRules');
    };
    var onmessage=function(event){
        var data=event.data;
        var origin=event.origin;
    };
    if(typeof window.addEventListener !='undefined'){
       window.addEventListener('message',onmessage,false);
    }*/

    /*window.addEventListener('message',function(e){
        console.log('data--->'+ e.data);
    },false);*/

    /*window.onload=function(){
        var frameObj=document.getElementById("getVPC");
        var frameContent=frameObj.getElementsByTagName("body");
        alert(frameContent);
        console.log(frameContent);
    }*/
</script>

<script type="text/javascript">
    var pageSize = 20;    //每页显示的记录条数
    var curPage=0;        //当前页
    var lastPage;        //最后页
    var direct=0;        //方向
    var len;            //总行数
    var page;            //总页数
    var begin;
    var end;
    $(function(){
        /*var search_input=$("#searchInput");
        var search_content=$("#policy-table");
        $(search_input).on("keyup",function(){
            var searchValue=$(this).val();
            var val=
            if(searchValue!==''){

            }
        });*/
        getVPCRules();
    });

    function getVPCRules(){
        $.ajax({
            type:'post',
            url:'json/getVPCRules.json',
            dataType:'json',
            success:function(data){
                for(var i=0;i<data.Output.firewall_rules.length;i++){
                    $("#policy-table").append("<tr><td>"+"<input type='checkbox' name='changeInfo'/>"+"</td><td>"+data.Output.firewall_rules[i].id+"</td><td>"+data.Output.firewall_rules[i].requirement_src_ip.join("<br/>")+"</td><td>"+data.Output.firewall_rules[i].requirement_dst_ip.join("<br/>")+"</td><td>"+data.Output.firewall_rules[i].requirement_protocol+"</td><td>"+""+"</td><td>"+data.Output.firewall_rules[i].start_time+"~"+data.Output.firewall_rules[i].end_time+"</td><td>"+data.Output.firewall_rules[i].requirement_timeout+"</td><td>"+data.Output.firewall_rules[i].requirement_action+"</td><td>"+""+"</td></tr>");
                }

                $("#allChange").click(function(){
                    if($(this).is(':checked')){
                        $("input[name='changeInfo']").each(function(){
                            $(this).prop("checked",true);
                        });
                    }else{
                        $("input[name='changeInfo']").each(function(){
                            $(this).removeAttr("checked",false);
                        });
                    }
                });


                len =$("#policy-table tr").length - 1;    // 求这个表的总行数，剔除第一行介绍
                page=len % pageSize==0 ? len/pageSize : Math.floor(len/pageSize)+1;//根据记录条数，计算页数
                // alert("page==="+page);
                curPage=1;    // 设置当前为第一页
                displayPage(1);//显示第一页

                document.getElementById("btn0").innerHTML="当前 " + curPage + "/" + page + " 页    每页 ";    // 显示当前多少页
                document.getElementById("allNum").innerHTML="数据总条数 " + len + "";        // 显示数据量
                document.getElementById("pageSize").value = pageSize;



                $("#btn1").click(function firstPage(){    // 首页
                    curPage=1;
                    direct = 0;
                    displayPage();
                });
                $("#btn2").click(function frontPage(){    // 上一页
                    direct=-1;
                    displayPage();
                });
                $("#btn3").click(function nextPage(){    // 下一页
                    direct=1;
                    displayPage();
                });
                $("#btn4").click(function lastPage(){    // 尾页
                    curPage=page;
                    direct = 0;
                    displayPage();
                });
                $("#btn5").click(function changePage(){    // 转页
                    curPage=document.getElementById("changePage").value * 1;
                    if (!/^[1-9]\d*$/.test(curPage)) {
                        alert("请输入正整数");
                        return ;
                    }
                    if (curPage > page) {
                        alert("超出数据页面");
                        return ;
                    }
                    direct = 0;
                    displayPage();
                });


                $("#pageSize").click(function setPageSize(){    // 设置每页显示多少条记录
                    pageSize = document.getElementById("pageSize").value;    //每页显示的记录条数
                    if (!/^[1-9]\d*$/.test(pageSize)) {
                        alert("请输入正整数");
                        return ;
                    }
                    len =$("#policy-table tr").length - 1;
                    page=len % pageSize==0 ? len/pageSize : Math.floor(len/pageSize)+1;//根据记录条数，计算页数
                    curPage=1;        //当前页
                    direct=0;        //方向
//                      firstPage();
                    displayPage();
                });

            }
        });
    }
    function displayPage(){
        if(curPage <=1 && direct==-1){
            direct=0;
            alert("已经是第一页了");
            return;
        } else if (curPage >= page && direct==1) {
            direct=0;
            alert("已经是最后一页了");
            return ;
        }

        lastPage = curPage;

        // 修复当len=1时，curPage计算得0的bug
        if (len > pageSize) {
            curPage = ((curPage + direct + len) % len);
        } else {
            curPage = 1;
        }


        document.getElementById("btn0").innerHTML="当前 " + curPage + "/" + page + " 页    每页 ";        // 显示当前多少页

        begin=(curPage-1)*pageSize + 1;// 起始记录号
        end = begin + 1*pageSize - 1;    // 末尾记录号


        if(end > len ) end=len;
        $("#policy-table tr").hide();    // 首先，设置这行为隐藏
        $("#policy-table tr").each(function(i){    // 然后，通过条件判断决定本行是否恢复显示
            if((i>=begin && i<=end) || i==0 )//显示begin<=x<=end的记录
                $(this).show();
            if(len>10)
                $('#pagediv').show();
        });
    }

</script>

</body>
</html>

<div id="policyForm" class="modal fade" role="dialog" aria-hidden="true" tabindex="-1" style="z-index:2000;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
                <h4 class="modal-title">新增安全策略</h4>
            </div>
            <div class="modal-body">
                <form action="#" class="form-horizontal">
                    <div class="form-group">
                        <label class="control-label col-md-3">源地址:</label>
                        <input id="SA" class="col-md-8 layui-input" type="text" name="SA" value="" placeholder="请输入IP地址"/>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-md-3">目的地址:</label>
                        <input id="DA" class="col-md-8 layui-input" type="text" name="DA" value="" placeholder="请输入IP地址"/>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-md-3">协议:</label>
                        <input id="agreement" class="col-md-8 layui-input" type="text" name="agreement" value=""/>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-md-3">端口:</label>
                        <input id="port" class="col-md-8 layui-input" type="text" name="port" value=""/>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-md-3">时间段:</label>
                        <input id="dateTimeStart" class="col-md-8 layui-input datainp" type="text" placeholder="请选择时间段" readonly/>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-md-3">长连接:</label>
                        <input id="long-lived" class="col-md-8 layui-input" type="text" name="long-lived" value=""/>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-md-3">动作:</label>
                        <span class="col-md-3 pt">
                            <input type="radio" name="action" value="允许"/><span>允许</span>
                        </span>
                        <span class="col-md-3 pt">
                            <input type="radio" name="action" value="禁止"/><span>禁止</span>
                        </span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button id="subPolicy" type="button" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>
</div>
<script>
    jeDate("#dateTimeStart",{
        format:'YYYY-MM-DD hh:mm:ss',
        multiPane:false,
        range:"至"
    });
    $(function(){
        $(".policy-refresh").click(function(){
            location.reload();
        });
    });
</script>